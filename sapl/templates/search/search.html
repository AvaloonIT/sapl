{% extends 'crud/form.html' %}
{% load crispy_forms_tags %}
{% load common_tags %}

{% block base_content %}
  <h1><legend>Pesquisa Textual</legend></h1>
  </br>
  <form method="get" action=".">
    <div class="row">
      <div class="col-md-12">
        {{ form.q|as_crispy_field }}
      </div>
    </div>

    <div class="row">
      <div class="col-md-8">
        <h3> Em quais tipos de documento deseja pesquisar?</h3>
        <br/>
        <div class="checkbox" id="check_all">
          <label for="id_check_all">
            <input type="checkbox" id="id_check_all" onchange="checkAll(this)" /> Marcar/Desmarcar Todos
          </label>
        </div>
        <br/>
        {{ form.models }}
      </div>
    </div>

    <div  class="row">
      <div class="col-md-12">
        <input class="btn btn-primary float-right" type="submit" value="Pesquisar">
      </div>
    </div>
    </br>
    {% if query %}

    <h2>Por ano</h2>

    <div>
        <dl>
            {% if facets.fields.ano %}
                <dt>ano</dt>
                {% for ano in facets.fields.ano|slice:":5" %}
                    <dd><a href="{{ request.get_full_path }}&amp;selected_facets=ano:{{ ano.0|urlencode }}">{{ ano.0 }}</a> ({{ ano.1 }})</dd>
                {% endfor %}
            {% else %}
                <p>Sem facet de ano.</p>
            {% endif %}
        </dl>
    </div>
        <div>
        <dl>
            {% if facets.fields.tipo %}
                <dt>tipo</dt>
                {% for tipo in facets.fields.tipo|slice:":5" %}
                    <dd><a href="{{ request.get_full_path }}&amp;selected_facets=tipo:{{ tipo.0|urlencode }}">{{ tipo.0 }}</a> ({{ tipo.1 }})</dd>
                {% endfor %}
            {% else %}
                <p>Sem facet de tipo.</p>
            {% endif %}
        </dl>
    </div>

      <table class="table table-striped table-bordered">
        <thead class="thead-default">
          <tr><td><h3>Resultados - Foram encontrados {{ page_obj.paginator.count }} registros <br/>
            {% if page_obj.paginator.count %}
            Registros {{ page_obj.start_index }} a {{ page_obj.end_index }} de {{ page_obj.paginator.count }}
            {% endif %}
          </h3></td></tr>
        </thead>

      {% for result in page_obj.object_list %}
        <tr>
          <td>
            {% if result.object|search_get_model == 'm' %}
              <p>
                <strong>Matéria Legislativa: </strong> <a href="{% url 'sapl.materia:materialegislativa_detail' result.object.pk %}">{{ result.object }}</a></br>
                {{result.object.ementa|safe}}<br>

                {% if result.object.texto_original %}
                <strong>Texto Original:</strong> <a href="{{result.object.texto_original.url}}"> Clique aqui </a></br>
                {% endif %}
                {% if result.object.texto_articulado.exists %}
                  <strong>Texto Articulado:</strong> <a href="{% url 'sapl.materia:materia_ta' result.object.pk %}"> Clique aqui </a></br>
                {% endif %}
              </p>

            {% elif result.object|search_get_model == 'd' %}
              <p>
                <strong> Documento Acessório: </strong><a href="{% url 'sapl.materia:documentoacessorio_detail' result.object.pk %}">{{ result.object }}</a></br>
                {{result.object.ementa|safe}}<br>
                {% if result.object.arquivo %}
                <strong>Texto Original:</strong> <a href="{{result.object.arquivo.url}}"> Clique aqui </a></br>
                {% endif %}
              </p>

            {% elif result.object|search_get_model == 'n' %}
              <p>
                <strong> Norma Jurídica: </strong><a href="{% url 'sapl.norma:normajuridica_detail' result.object.pk %}">{{ result.object }}</a></br>
                {{ result.object.ementa|safe }}<br>
                {% if result.object.texto_integral %}
                <strong>Texto Original:</strong> <a href="{{result.object.texto_integral.url}}"> Clique aqui </a></br>
                {% endif %}
                {% if result.object.texto_articulado.exists %}
                  <strong>Texto Articulado:</strong> <a href="{% url 'sapl.norma:norma_ta' result.object.pk %}"> Clique aqui </a></br>
                {% endif %}
              </p>
            {% endif %}
          </td>
        </tr>

        {% empty %}
        <h3> Nenhum texto encontrado! </h3>
        <tr>
          <td>
          </td>
        </tr>
        {% endfor %}
      </table>

      {% if page_obj.has_previous or page_obj.has_next %}
        <div>
          {% if page_obj.has_previous %}
            <a href="{{ request.get_full_path }}&amp;page={{ page_obj.previous_page_number }}{{ models }}">
          {% endif %}&laquo; Anterior{% if page_obj.has_previous %}</a>{% endif %}
          |
          {% if page_obj.has_next %}
            <a href="{{ request.get_full_path }}&amp;page={{ page_obj.next_page_number }}{{ models }}">
          {% endif %}Próxima &raquo;{% if page_obj.has_next %}</a>{% endif %}
        </div>
      {% endif %}
    {% else %}
       {% if 'q=' in request.get_full_path %}
        <strong><h2>Favor informar um conjunto de caracteres na caixa 'Pesquisar' para realizar a busca</h2></strong>
       {% endif %}
    {% endif %}

  </form>
{% endblock %}

{% block extra_js %}

  <script language="JavaScript">
		function checkAll(elem) {
      let checkboxes = document.getElementsByName('models');
      for (let i = 0; i < checkboxes.length; i++) {
        if (checkboxes[i].type == 'checkbox') 
            checkboxes[i].checked = elem.checked; 
      }
    }
  </script>

{% endblock %}